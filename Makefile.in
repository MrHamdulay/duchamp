CFLAGS = -O2 -ftree-vectorize

FFLAGS = -C -fast -O4

CC =    @CC@ $(CFLAGS)
CXX =   @CXX@ $(CFLAGS)
F77=    @F77@ $(FFLAGS)
LINK=   @LINKER@

BASE = ./src

INSTALLDIR = @prefix@/bin
LIBDIR = @prefix@/lib
INCDIR = @prefix@/include/duchamp

V = @PACKAGE_VERSION@
EXEC = Duchamp-$(V)
EXEC-STUB = Duchamp

AR = ar cq
LIB = libduchamp.a

INSTALL = @INSTALL@
LN_S = @LN_S@

PGPLOTINC = @PGPLOTINC@
PGPLOTLIB = @PGPLOTLIB@

CFITSIOINC = @CFITSIOINC@
CFITSIOLIB = @CFITSIOLIB@

WCSINC = @WCSINC@
WCSLIB = @WCSLIB@

CINC = $(PGPLOTINC) $(WCSINC) $(CFITSIOINC) -I$(BASE)

LIBS = $(WCSLIB) $(CFITSIOLIB) $(PGPLOTLIB)

ATROUSDIR = $(BASE)/ATrous
PIXELMAPDIR = $(BASE)/PixelMap
DETECTIONDIR = $(BASE)/Detection
CUBESDIR = $(BASE)/Cubes
FITSIODIR = $(BASE)/FitsIO
UTILDIR = $(BASE)/Utils
TESTDIR = ./verification

HEADS = $(BASE)/duchamp.hh\
	$(BASE)/pgheader.hh\
	$(BASE)/param.hh\
	$(BASE)/fitsHeader.hh\
	$(PIXELMAPDIR)/Voxel.hh\
	$(PIXELMAPDIR)/Scan.hh\
	$(PIXELMAPDIR)/Object2D.hh\
	$(PIXELMAPDIR)/Object3D.hh\
	$(ATROUSDIR)/atrous.hh\
	$(ATROUSDIR)/filter.hh\
	$(DETECTIONDIR)/detection.hh\
	$(DETECTIONDIR)/columns.hh\
	$(DETECTIONDIR)/finders.hh\
	$(CUBESDIR)/cubes.hh\
	$(CUBESDIR)/plots.hh\
	$(CUBESDIR)/VOTable.hh\
	$(UTILDIR)/Hanning.hh\
	$(UTILDIR)/GaussSmooth1D.hh\
	$(UTILDIR)/GaussSmooth2D.hh\
	$(UTILDIR)/Section.hh\
	$(UTILDIR)/Statistics.hh\
	$(UTILDIR)/utils.hh\
	$(UTILDIR)/feedback.hh\
	$(UTILDIR)/mycpgplot.hh

OBJECTS-NOPG = $(BASE)/mainDuchamp.o \
	$(BASE)/duchamp.o\
	$(BASE)/param.o\
	$(BASE)/fitsHeader.o\
	$(PIXELMAPDIR)/Voxel.o\
	$(PIXELMAPDIR)/Scan.o\
	$(PIXELMAPDIR)/Object2D.o\
	$(PIXELMAPDIR)/Object3D.o\
	$(ATROUSDIR)/filter.o\
	$(ATROUSDIR)/atrous_1d_reconstruct.o\
	$(ATROUSDIR)/atrous_2d_reconstruct.o\
	$(ATROUSDIR)/atrous_3d_reconstruct.o\
	$(ATROUSDIR)/baselineSubtract.o\
	$(ATROUSDIR)/ReconSearch.o\
	$(DETECTIONDIR)/detection.o\
	$(DETECTIONDIR)/columns.o\
	$(DETECTIONDIR)/areClose.o\
	$(DETECTIONDIR)/growObject.o\
	$(DETECTIONDIR)/lutz_detect.o\
	$(DETECTIONDIR)/mergeIntoList.o\
	$(DETECTIONDIR)/outputDetection.o\
	$(DETECTIONDIR)/sorting.o\
	$(DETECTIONDIR)/spectrumDetect.o\
	$(CUBESDIR)/cubes.o\
	$(CUBESDIR)/cubes_extended.o\
	$(CUBESDIR)/baseline.o\
	$(CUBESDIR)/CubicSearch.o\
	$(CUBESDIR)/detectionIO.o\
	$(CUBESDIR)/existingDetections.o\
	$(CUBESDIR)/getImage.o\
	$(CUBESDIR)/invertCube.o\
	$(CUBESDIR)/Merger.o\
	$(CUBESDIR)/momentMap.o\
	$(CUBESDIR)/readRecon.o\
	$(CUBESDIR)/readSmooth.o\
	$(CUBESDIR)/saveImage.o\
	$(CUBESDIR)/smoothCube.o\
	$(CUBESDIR)/spectraUtils.o\
	$(CUBESDIR)/trimImage.o\
	$(CUBESDIR)/VOTable.o\
	$(FITSIODIR)/dataIO.o\
	$(FITSIODIR)/headerIO.o\
	$(FITSIODIR)/subsection.o\
	$(FITSIODIR)/wcsIO.o\
	$(UTILDIR)/Section.o\
	$(UTILDIR)/Statistics.o\
	$(UTILDIR)/feedback.o\
	$(UTILDIR)/GaussSmooth1D.o\
	$(UTILDIR)/Hanning.o\
	$(UTILDIR)/getStats.o\
	$(UTILDIR)/linear_regression.o\
	$(UTILDIR)/position_related.o\
	$(UTILDIR)/sort.o\
	$(UTILDIR)/wcsFunctions.o\
	$(UTILDIR)/zscale.o

ifeq ($(strip $(PGPLOTLIB)),)
  OBJECTS = $(OBJECTS-NOPG)
else
  OBJECTS = $(OBJECTS-NOPG)\
	$(CUBESDIR)/drawBlankEdges.o\
	$(CUBESDIR)/drawMomentCutout.o\
	$(CUBESDIR)/outputSpectra.o\
	$(CUBESDIR)/plotting.o\
	$(UTILDIR)/mycpgplot.o\
	$(CUBESDIR)/plots.o\
	$(UTILDIR)/pgplot_related.o
endif

duchamp : $(OBJECTS)
	$(LINK) -o $(EXEC) $(OBJECTS) $(LIBS)

lib     : $(OBJECTS)
	$(AR) $(LIB) $(OBJECTS)

createTestImage : $(TESTDIR)/createTestImage.o $(UTILDIR)/get_random_spectrum.o
	$(CXX) -o createTestImage.x\
	$(TESTDIR)/createTestImage.o $(UTILDIR)/get_random_spectrum.o\
	$(CFITSIOLIB) @LIBS@

install : 
	$(INSTALL) -d -m 2755 $(INSTALLDIR)
	$(INSTALL) -m 755 $(EXEC) $(INSTALLDIR)
	$(RM) $(INSTALLDIR)/$(EXEC-STUB)
	cd $(INSTALLDIR) && $(LN_S) $(EXEC) $(EXEC-STUB)
	-test ! -f $(LIB) || $(INSTALL) -d -m 2755 $(LIBDIR)
	-test ! -f $(LIB) || $(INSTALL) -m 644 $(LIB) $(LIBDIR)
	$(INSTALL) -d -m 2755 $(INCDIR)
	$(INSTALL) -m 644 $(BASE)/*.hh $(INCDIR)
	$(INSTALL) -m 644 $(BASE)/*.h $(INCDIR)
	$(INSTALL) -d -m 2755 $(INCDIR)/Cubes
	$(INSTALL) -m 644 $(CUBESDIR)/*.hh $(INCDIR)/Cubes
	$(INSTALL) -d -m 2755 $(INCDIR)/ATrous
	$(INSTALL) -m 644 $(ATROUSDIR)/*.hh $(INCDIR)/ATrous
	$(INSTALL) -d -m 2755 $(INCDIR)/Detection
	$(INSTALL) -m 644 $(DETECTIONDIR)/*.hh $(INCDIR)/Detection
	$(INSTALL) -d -m 2755 $(INCDIR)/PixelMap
	$(INSTALL) -m 644 $(PIXELMAPDIR)/*.hh $(INCDIR)/PixelMap
	$(INSTALL) -d -m 2755 $(INCDIR)/Utils
	$(INSTALL) -m 644 $(UTILDIR)/*.hh $(INCDIR)/Utils

$(OBJECTS) : $(HEADS)

.cc.o:
	$(CXX) -c $< $(CINC) -o $@

.c.o:
	$(CC) -c $< $(CINC) -o $@

clean : 
	rm -f $(BASE)/*.o $(ATROUSDIR)/*.o $(CUBESDIR)/*.o $(FITSIODIR)/*.o $(DETECTIONDIR)/*.o $(UTILDIR)/*.o $(PIXELMAPDIR)/*.o
